/* Generated by chatGPT 4o */

window.addEventListener('unhandledrejection', event => {
    console.error('Unhandled promise rejection:', event.reason);
});

document.addEventListener('DOMContentLoaded', () => {
    const mainMenu = document.getElementById('main-menu');
    const navContainer = document.getElementById('nav-container');
    const contentElem = document.getElementById('content');
    const menuToggle = document.getElementById('menu-toggle');
    const navWrapper = document.getElementById('nav-wrapper');

    // Helper to fetch sub-menu
    const fetchSubMenu = async (folder, level) => {
        try {
            const response = await fetch(`navigation_sub.php?folder=${encodeURIComponent(folder)}`);
            const data = await response.json();

            // Remove all sub-menus below the current level
            Array.from(navContainer.children).slice(level).forEach(subMenu => subMenu.remove());

            // Add new sub-menu if there are items to show
            if (Object.keys(data).length > 0) {
                const subMenuContainer = document.createElement('div');
                subMenuContainer.className = 'nav-menu';
                subMenuContainer.innerHTML = `<ul id="sub-menu-${level}"></ul>`;
                navContainer.appendChild(subMenuContainer);

                const ulElem = subMenuContainer.querySelector('ul');
                for (const key in data) {
                    const displayKey = key.replace(/^#\d+\s*/, '').replace(/\.txt$/, '');
                    if (typeof data[key] === 'object') {
                        ulElem.innerHTML += `<li class="folder" data-folder="${folder}/${key}" data-level="${level + 1}">${displayKey}</li>`;
                    } else {
                        ulElem.innerHTML += `<li class="file" data-file="${encodeURIComponent(data[key])}">${displayKey}</li>`;
                    }
                }
            }

            adjustNavContainerWidth();
        } catch (error) {
            console.error('Error fetching sub-menu data:', error);
        }
    };

    // Helper to fetch content
    const fetchContent = async (path, type = 'file') => {
        try {
            const response = await fetch(`content.php?${type}=${encodeURIComponent(path)}`);
            const html = await response.text();
            contentElem.innerHTML = html;

            // Content has been replaced; make sure dynamic scripts run
            const scripts = Array.from(contentElem.getElementsByTagName('script'));
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.innerHTML = oldScript.innerHTML;
                document.body.appendChild(newScript).parentNode.removeChild(newScript);
            });
        } catch (error) {
            console.error('Error fetching content:', error);
        }
    };

    // Adjust navigation container width
    const adjustNavContainerWidth = () => {
        const subMenus = document.querySelectorAll('.nav-menu');
        let totalWidth = 0;
        let count = 0;
        subMenus.forEach(subMenu => {
            if (count >= 1) {
                totalWidth += subMenu.offsetWidth;
            }
            count += 1;
        });
        navContainer.style.width = `${totalWidth}px`;
    };

    // Main menu click handler
    mainMenu.addEventListener('click', (event) => {
        const target = event.target;

        if (target.tagName === 'LI') {
            for (const child of mainMenu.children) {
                child.classList.remove('active');
            }
            target.classList.add('active');
        }

        if (target.classList.contains('main-folder')) {
            const folder = target.getAttribute('data-folder');
            fetchContent(folder, 'folder'); // Load main folder's index content
            fetchSubMenu(folder, 0); // Load sub-menu items
        }
    });

    // Navigation container click handler
    navContainer.addEventListener('click', (event) => {
        const target = event.target;

        if (target.tagName === 'LI') {
            const siblings = target.parentNode.children;
            for (let i = 0; i < siblings.length; i++) {
                if (siblings[i] !== target) {
                    siblings[i].classList.remove('active');
                }
            }
            target.classList.add('active');
        }

        if (target.classList.contains('folder')) {
            const folder = target.getAttribute('data-folder');
            const level = parseInt(target.getAttribute('data-level'), 10);
            fetchContent(folder, 'folder'); // Load sub-folder's index content
            fetchSubMenu(folder, level); // Load further sub-menu items
        } else if (target.classList.contains('file')) {
            const filePath = target.getAttribute('data-file');
            fetchContent(filePath, 'file');
        }
    });

    adjustNavContainerWidth();

    // Mobile menu toggle
    menuToggle.addEventListener('click', () => {
        navWrapper.classList.toggle('open');
    });

    // Close navigation menu when clicking on the content area on mobile
    contentElem.addEventListener('click', () => {
        if (window.innerWidth <= 900) {
            navWrapper.classList.remove('open');
        }
    });

    // Ensure menu closes when the viewport is resized to more than 900px
    window.addEventListener('resize', () => {
        if (window.innerWidth > 900) {
            navWrapper.classList.remove('open');
        }
    });

    //Egg chart
    const observer = new MutationObserver(() => initializeEggTable());
    observer.observe(contentElem, { childList: true, subtree: true });

    // Initial call to ensure the table is initialized if already present
    initializeEggTable();
});

function initializeEggTable() {
    const table = document.getElementById('eggTable');

    if (!table) {
        return;  // No table found, exit the function.
    }

    if (table.dataset.initialized) {
        return;  // Exit if the table is already initialized to avoid duplicate event listeners.
    }

    table.dataset.initialized = true;  // Mark the table as initialized.

    loadTableState(table);

    table.addEventListener('click', function (event) {
        if (event.target.tagName === 'TD') {
            toggleCell(event.target);
            saveTableState(table);
        }
    });
}

function toggleCell(cell) {
    const currentValue = cell.innerText.trim();
    const newValue = currentValue === "-" ? "✓" : "-";
    cell.innerText = newValue;
    cell.className = newValue === "-" ? "cell-0" : "cell-1";
}

function saveTableState(table) {
    const cells = table.getElementsByTagName('td');
    const state = Array.from(cells).map(cell => cell.innerText.trim());
    document.cookie = "tableState=" + JSON.stringify(state) + "; path=/";
}

function loadTableState(table) {
    const state = getCookie('tableState');
    if (!state) {
        // If there is no saved state, initialize all cells to "-"
        initializeDefaultState(table);
        return;
    }

    const cells = table.getElementsByTagName('td');
    const cellValues = JSON.parse(state);
    for (let i = 0; i < cells.length; i++) {
        const cellValue = cellValues[i];
        if (cellValue === "-" || cellValue === "✓") {
            cells[i].innerText = cellValue;
            cells[i].className = cellValue === "-" ? "cell-0" : "cell-1";
        } else {
            cells[i].innerText = "-";
            cells[i].className = "cell-0";
        }
    }
}

function initializeDefaultState(table) {
    const cells = table.getElementsByTagName('td');
    for (let cell of cells) {
        cell.innerText = "-";
        cell.className = "cell-0";
    }
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}